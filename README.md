# Notification service

## Введение

В данном репозитории распологается код приложения для отправления сообщений по различным каналам связи.
На данный момент доступно отправление сообщений через:
- Email (электронная почта)
- Telegram

Приложение реализует микросервисную архитектуру и состоит из следующих микросервисов:
1. Notification service
2. Workers:
    1. Email notifier
    2. Telegram notifier

Также написан код для телеграм бота, через который идет отправление сообщений в телеграмме.
Описание каждого конкретного сервиса находится в соответсвующей разделе

## Описание работы

1. Пользователи "регистрируются" в системе, указывая username и контакты, по которым им будут поступать сообщения. Эти данные сохраняются в базе данных.
2. Пользователь, решивший отправить сообщение, отправляет запрос, указывая имя адресата и тип контакта, по которому требуется отправить сообщение
3. Запрос на отправку сообщений сохраняется в очереди сообщений (Rabbit) в отведенном для данного типа контакта канале
4. Микросервисы-воркеры читают определенный для своего типа контакта канал в очереди сообщений и обрабатвают запросы, отправляя сообщения адресатам

## Notification service

Главный микросервис, с которым взаимодействуют пользователи. Отвечает за:
1. Получение запроса на отправку сообщений и добавление в очеред сообщений (Rabbit)
2. Регистрацию пользователей
3. Изменение информации о пользователей
4. Получение данных о контактах пользователя по его имени и типу канала связи

### Энпоинты

POST - Отправка сообщений - ``` event/send ```

В теле запроса указываются данные в виде [Event](https://github.com/notanumer/notification-service/blob/main/database-service/DatabaseService.Models/Rabbit/Event.cs)

**Важно:** в поле Recipient передается не контакт адресата (например, почта), а **userName**, указаный адресатом при регистрации.

POST - Регистрация пользователя - ``` user/create ```

В теле запроса указываются данные в виде [CreateUserRequest](https://github.com/notanumer/notification-service/blob/main/database-service/DatabaseService.Models/Postgres/CreateUserRequest.cs)

PATCH - Измение информации о пользователе - ``` setCredentials/{userName} ```

В теле запроса указывается данные в виде [Credentials](https://github.com/notanumer/notification-service/blob/main/database-service/DatabaseService.Models/Postgres/Credentials.cs)

GET - Получение информации о контакте пользователя по конкретному каналу связи - ``` getCredentials/{userName}/{credentialType} ```

## Email notifier

Микросервис воркер, отвечающй за отправку сообщений по электронной почте.
Сообщения отправляются через **сервисную почту**, а не через почту пользователей.

## Telegram notifier

Микросервис воркер, отвечающий за отправку сообщений в телеграме.
Сообщения отправляются через специально написанного бота, поэтому, чтобы сообщение дошло до адресата, он дожен запустить диалог с ботом в своей аккаунте. Иначе сообщение отправлено не будет.

## Запуск

Перед запуском необходимо заполнить следующие данные в файле .env:
1. Для запуска телеграм бота необходимо указать  токен (TG_TOKEN)
2. Для запуска почтового сервиса необходимо указать адрес сервисной почты (SMTP_EMAIL), пароль от нее (SMTP_PASSWORD) и хост (SMTP_HOST)
3. (Не обязательно для тестового запуска) Для бд и ELK нужно указать пароли.

**Важно:** У указанной почты должны быть настроены разрешения на отправку сообщениц через сторонние системы. У каждого почтового сервиса свои настройки, поэтому как выдать разрешения нужно найти и выполнить самостоятельно

После заполнения данных нужно ввести следующие команды: 

**Важно:** Все команды необходимо запускать из папки __manifests__

1. ``` docker compose up setup ``` - в конце выполнения команды должен быть ``` Exit code 0 ```
2. ``` docker compose up -d ```
3. ``` docker compose --profile microservices up -d ```